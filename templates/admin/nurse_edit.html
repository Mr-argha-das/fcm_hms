{% extends "admin/base.html" %}
{% block title %}Manage Nurse{% endblock %}

{% block content %}
<div class="card mb-4">
  <h4>Manage Nurse</h4>
  <p class="text-muted">Admin controls & verification</p>
</div>

<form id="nurseForm">

  <!-- VERIFICATION -->
  <div class="card mb-4">
    <h5>Verification</h5>

    <input type="checkbox" name="aadhaar_verified"
      {% if nurse.aadhaar_verified %}checked{% endif %}> Aadhaar Verified

    <select name="police_verification_status" class="form-select mt-2">
      {% for s in ["PENDING","CLEAR","FAILED"] %}
        <option value="{{ s }}"
          {% if nurse.police_verification_status==s %}selected{% endif %}>
          {{ s }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- PROFILE -->
  <div class="card mb-4">
    <h5>Profile</h5>

    <select name="nurse_type" class="form-select mb-2">
      {% for t in ["GNM","ANM","CARETAKER","PHYSIO","COMBO"] %}
        <option value="{{ t }}" {% if nurse.nurse_type==t %}selected{% endif %}>
          {{ t }}
        </option>
      {% endfor %}
    </select>

    <input type="date" name="joining_date" class="form-control mb-2"
           value="{{ nurse.joining_date }}">

    <input type="date" name="resignation_date" class="form-control mb-2"
           value="{{ nurse.resignation_date }}">

    <input type="checkbox" name="is_active"
      {% if nurse.user.is_active %}checked{% endif %}> Active Nurse
  </div>

  <!-- SALARY -->
  <div class="card mb-4">
    <h5>Salary</h5>

    <select name="salary_type" class="form-select mb-2">
      <option value="DAILY">DAILY</option>
      <option value="MONTHLY" selected>MONTHLY</option>
    </select>

    <input type="number" name="salary_amount" class="form-control mb-2"
           value="{{ consent.salary_amount if consent else '' }}">

    <select name="payment_mode" class="form-select mb-2">
      {% for p in ["CASH","BANK","UPI"] %}
        <option value="{{ p }}"
          {% if consent and consent.payment_mode==p %}selected{% endif %}>
          {{ p }}
        </option>
      {% endfor %}
    </select>

    <input type="number" name="salary_date" min="1" max="31"
           class="form-control"
           value="{{ consent.salary_date if consent else '' }}">
  </div>

  <button class="btn btn-success">üíæ Save Changes</button>
</form>

<script>
const API = "https://wecarehhcs.in";

document.getElementById("nurseForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const form = this;
  const formData = new FormData(form);

  // checkbox fix for FastAPI
  formData.set("aadhaar_verified", form.aadhaar_verified.checked ? "true" : "false");
  formData.set("is_active", form.is_active.checked ? "true" : "false");

  const res = await fetch(`${API}/admin/nurses/{{ nurse.id }}/update`, {
    method: "POST",
    headers: {
      Authorization: "Bearer " + localStorage.getItem("token")
    },
    body: formData
  });

  const data = await res.json();

  if (data.success) {
    alert("‚úÖ Updated successfully");
    location.reload();
  } else {
    alert("‚ùå Update failed");
    console.log(data);
  }
});
</script>
{% endblock %}
