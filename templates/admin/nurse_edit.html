{% extends "admin/base.html" %}
{% block title %}Manage Nurse{% endblock %}

{% block content %}

<div class="bg-card p-3 mb-3 border border-gray-50/20 rounded-2xl shadow-soft4">
  <h4>Manage Nurse</h4>
  <p class="text-muted">Admin controls & verification</p>
</div>

<form id="nurseForm">

  <!-- ================= VERIFICATION ================= -->
 <div class="bg-card px-3  pt-3 mb-3 border border-gray-50/20 rounded-2xl shadow-soft4">

    <h5 class="text-md font-semibold mb-2 ">Verification</h5>

    <div class="form-check mb-2">
      <input
        class="form-check-input"
        type="checkbox"
        name="aadhaar_verified"
        {{ 'checked' if nurse.aadhaar_verified else '' }}
      />
      <label class="form-check-label ">Aadhaar Verified</label>
    </div>

    <div class="mb-3">
      <label>Police Verification</label>
      <select class="form-select" name="police_verification_status">
        {% for s in ["PENDING","CLEAR","FAILED"] %}
        <option value="{{ s }}"
          {{ 'selected' if nurse.police_verification_status == s else '' }}>
          {{ s }}
        </option>
        {% endfor %}
      </select>
    </div>
  </div>

  <!-- ================= PROFILE ================= -->
 <div class="bg-card px-3  py-3 mb-3 border border-gray-50/20 rounded-2xl shadow-soft4">
   <h5 class="text-md font-semibold mb-2 ">Profile</h5>

    <div class="row">
      <div class="col-md-4 mb-3">
        <label>Nurse Type</label>
        <select class="form-select" name="nurse_type">
          {% for t in ["GNM","ANM","CARETAKER","PHYSIO","COMBO","OTHER"] %}
          <option value="{{ t }}"
            {{ 'selected' if nurse.nurse_type == t else '' }}>
            {{ t }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4 mb-3">
        <label>Joining Date</label>
        <input
          type="date"
          class="form-control"
          name="joining_date"
          value="{{ nurse.joining_date.strftime('%Y-%m-%d') if nurse.joining_date else '' }}"
        />
      </div>

      <div class="col-md-4 mb-3">
        <label>Resignation Date</label>
        <input
          type="date"
          class="form-control"
          name="resignation_date"
          value="{{ nurse.resignation_date.strftime('%Y-%m-%d') if nurse.resignation_date else '' }}"
        />
      </div>
    </div>

    <div class="form-check mt-2">
      <input
        class="form-check-input"
        type="checkbox"
        name="is_active"
        {{ 'checked' if nurse.user and nurse.user.is_active else '' }}
      />
      <label class="form-check-label">Active Nurse</label>
    </div>
  </div>

  <!-- ================= SALARY ================= -->
 <div class="bg-card px-3  pt-3 mb-3 border border-gray-50/20 rounded-2xl shadow-soft4">
 <h5 class="text-md font-semibold mb-2 ">Salary & Payment</h5>

    <div class="row">
      <div class="col-md-3 mb-3">
        <label>Salary Type</label>
        <select class="form-select" name="salary_type">
          {% for t in ["DAILY","MONTHLY"] %}
          <option value="{{ t }}"
            {{ 'selected' if consent and consent.salary_type == t else '' }}>
            {{ t }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3 mb-3">
        <label>Salary Amount</label>
        <input
          type="number"
          step="0.01"
          class="form-control"
          name="salary_amount"
          value="{{ consent.salary_amount if consent else '' }}"
          required
        />
      </div>

      <div class="col-md-3 mb-3">
        <label>Payment Mode</label>
        <select class="form-select" name="payment_mode">
          {% for p in ["CASH","BANK","UPI"] %}
          <option value="{{ p }}"
            {{ 'selected' if consent and consent.payment_mode == p else '' }}>
            {{ p }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3 mb-3">
        <label>Salary Date</label>
        <input
          type="number"
          min="1"
          max="31"
          class="form-control"
          name="salary_date"
          value="{{ consent.salary_date if consent else '' }}"
          required
        />
      </div>
    </div>
  </div>

  <!-- ================= SUBMIT ================= -->
  <button type="button" class="btn btn-success" id="submitBtn">
    üíæ Save Changes
  </button>
  <a href="/admin/nurses/{{ nurse.id }}" class="btn btn-secondary">Cancel</a>

</form>

<!-- ================= JS ================= -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  function headers() {
    return {
      Authorization: "Bearer " + localStorage.getItem("token"),
    };
  }

  if (!localStorage.getItem("token")) {
    window.location.href = "/admin/login";
  }

  const form = document.getElementById("nurseForm");
  const btn = document.getElementById("submitBtn");

  btn.addEventListener("click", async () => {
    const formData = new FormData(form);

    // checkbox ‚Üí string for FastAPI
    formData.set("aadhaar_verified", form.aadhaar_verified.checked ? "true" : "false");
    formData.set("is_active", form.is_active.checked ? "true" : "false");

    const res = await fetch(`/admin/nurse/{{ nurse.id }}/update`, {
      method: "POST",
      headers: headers(),
      body: formData,
    });

    const data = await res.json();

    if (!res.ok) {
      alert(data.detail || "‚ùå Update failed");
      return;
    }

    alert("‚úÖ Nurse updated successfully");
    window.location.reload();
  });
});
</script>

{% endblock %}
