{% extends "admin/base.html" %}
{% block title %}Manage Nurse{% endblock %}

{% block content %}

<div class="card mb-4">
  <h4>Manage Nurse</h4>
  <p class="text-muted">Admin controls & verification</p>
</div>

<form id="nurseForm">

<!-- ================= VERIFICATION ================= -->
<div class="card mb-4">
  <h5>Verification</h5>

  <div class="form-check mb-2">
    <input class="form-check-input"
           type="checkbox"
           name="aadhaar_verified"
           {% if nurse.aadhaar_verified %}checked{% endif %}>
    <label class="form-check-label">Aadhaar Verified</label>
  </div>

  <div class="mb-3">
    <label>Police Verification</label>
    <select class="form-select" name="police_verification_status">
      {% for s in ["PENDING","CLEAR","FAILED"] %}
        <option value="{{ s }}"
          {% if nurse.police_verification_status == s %}selected{% endif %}>
          {{ s }}
        </option>
      {% endfor %}
    </select>
  </div>
</div>

<!-- ================= PROFILE ================= -->
<div class="card mb-4">
  <h5>Profile</h5>

  <div class="row">
    <div class="col-md-4 mb-3">
      <label>Nurse Type</label>
      <select class="form-select" name="nurse_type">
        {% for t in ["GNM","ANM","CARETAKER","PHYSIO","COMBO"] %}
          <option value="{{ t }}"
            {% if nurse.nurse_type == t %}selected{% endif %}>
            {{ t }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-4 mb-3">
      <label>Joining Date</label>
      <input type="date"
             class="form-control"
             name="joining_date"
             value="{{ nurse.joining_date }}">
    </div>

    <div class="col-md-4 mb-3">
      <label>Resignation Date</label>
      <input type="date"
             class="form-control"
             name="resignation_date"
             value="{{ nurse.resignation_date }}">
    </div>
  </div>

  <div class="form-check mt-2">
    <input class="form-check-input"
           type="checkbox"
           name="is_active"
           {% if nurse.user and nurse.user.is_active %}checked{% endif %}>
    <label class="form-check-label">Active Nurse</label>
  </div>
</div>

<!-- ================= SALARY ================= -->
<div class="card mb-4">
  <h5>Salary & Payment</h5>

  <div class="row">
    <div class="col-md-3 mb-3">
      <label>Salary Type</label>
      <select class="form-select" name="salary_type">
        {% for t in ["DAILY","MONTHLY"] %}
          <option value="{{ t }}"
            {% if consent and consent.salary_type == t %}selected{% endif %}>
            {{ t }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3 mb-3">
      <label>Salary Amount</label>
      <input type="number"
             step="0.01"
             class="form-control"
             name="salary_amount"
             value="{{ consent.salary_amount if consent else '' }}">
    </div>

    <div class="col-md-3 mb-3">
      <label>Payment Mode</label>
      <select class="form-select" name="payment_mode">
        {% for p in ["CASH","BANK","UPI"] %}
          <option value="{{ p }}"
            {% if consent and consent.payment_mode == p %}selected{% endif %}>
            {{ p }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3 mb-3">
      <label>Salary Date</label>
      <input type="number"
             min="1"
             max="31"
             class="form-control"
             name="salary_date"
             value="{{ consent.salary_date if consent else '' }}">
    </div>
  </div>
</div>

<!-- Submit -->
<button type="button" class="btn btn-success" id="submitBtn">üíæ Save Changes</button>
<a href="/admin/nurses/{{ nurse.id }}" class="btn btn-secondary">Cancel</a>

</form>

<!-- ================= JS ================= -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  const API = "https://wecarehhcs.in";

  function headers() {
    return {
      Authorization: "Bearer " + localStorage.getItem("token"),
    };
  }

  function guard() {
    if (!localStorage.getItem("token")) {
      window.location.href = "/admin/login";
    }
  }

  guard();

  const form = document.getElementById("nurseForm");
  const btn = document.getElementById("submitBtn");

  btn.addEventListener("click", async () => {

    const formData = new FormData(form);

    // ‚úÖ Checkbox fix
    formData.set("aadhaar_verified", form.aadhaar_verified.checked ? "true" : "false");
    formData.set("is_active", form.is_active.checked ? "true" : "false");

    try {
      const res = await fetch(`${API}/admin/nurses/{{ nurse.id }}/update`, {
        method: "POST",
        headers: headers(),
        body: formData
      });

      if (!res.ok) {
        const data = await res.json();
        alert(data.detail || "‚ùå Update failed");
        return;
      }

      alert("‚úÖ Nurse updated successfully");
      window.location.reload();

    } catch (err) {
      console.error(err);
      alert("‚ùå Server error");
    }
  });

});
</script>

{% endblock %}
