{% extends "admin/base.html" %}
{% block title %}Patient Details{% endblock %}

{% block content %}
<script>
  guard();
</script>

<h4 class="mb-4">üßë‚Äç‚öïÔ∏è Patient Details</h4>

<!-- ================= TABS ================= -->
<ul class="nav nav-tabs mb-4">
  <li class="nav-item">
    <a class="nav-link active" data-bs-toggle="tab" href="#tab-details">
      üßë‚Äç‚öïÔ∏è Details
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" data-bs-toggle="tab" href="#tab-billing">
      üí∞ Billing
    </a>
  </li>
</ul>

<div class="tab-content">

<!-- ========================================================= -->
<!-- ================= DETAILS TAB =========================== -->
<!-- ========================================================= -->
<div class="tab-pane fade show active" id="tab-details">

<!-- ================= PATIENT BASIC INFO ================= -->
<div class="card shadow-sm mb-4">
  <div class="card-header bg-light">
    <b>üë§ Basic Information</b>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-4">
        <p><b>Name:</b> {{ patient.user.name }}</p>
        <p><b>Phone:</b> {{ patient.user.phone }}</p>
        <p><b>Email:</b> {{ patient.user.email or "-" }}</p>
      </div>
      <div class="col-md-4">
        <p><b>Age:</b> {{ patient.age }}</p>
        <p><b>Gender:</b> {{ patient.gender }}</p>
        <p><b>Address:</b> {{ patient.address }}</p>
      </div>
      <div class="col-md-4">
        <p><b>Service Start:</b> {{ patient.service_start }}</p>
        <p><b>Service End:</b> {{ patient.service_end if patient.service_end else "‚Äî" }}</p>
        <p>
          <b>Assigned Doctor:</b>
          {% if doctor %}
            Dr. {{ doctor.user.name }} ({{ doctor.specialization }})
          {% else %}
            <span class="text-muted">Not Assigned</span>
          {% endif %}
        </p>
      </div>
    </div>
  </div>
</div>

<!-- ================= NURSE VISITS ================= -->
<div class="card shadow-sm mb-4">
  <div class="card-header bg-light">
    <b>üë©‚Äç‚öïÔ∏è Nurse Visits</b>
  </div>
  <div class="card-body">
    {% if duties %}
    <table class="table table-sm table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Nurse</th>
          <th>Nurse Type</th>
          <th>Duty Type</th>
          <th>Shift</th>
          <th>Start</th>
          <th>End</th>
        </tr>
      </thead>
      <tbody>
        {% for duty in duties %}
        <tr>
          <td>{{ duty.nurse.user.name }}</td>
          <td>{{ duty.nurse.nurse_type }}</td>
          <td>{{ duty.duty_type }}</td>
          <td>{{ duty.shift }}</td>
          <td>{{ duty.duty_start.strftime("%d %b %Y %H:%M") }}</td>
          <td>{{ duty.duty_end.strftime("%d %b %Y %H:%M") }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="text-muted">No nurse visits recorded.</p>
    {% endif %}
  </div>
</div>

<!-- ================= DAILY NOTES ================= -->
<div class="card shadow-sm mb-4">
  <div class="card-header bg-light">
    <b>üìù Daily Nursing Notes</b>
  </div>
  <div class="card-body">
    {% if notes %}
    <table class="table table-sm table-bordered">
      <thead class="table-light">
        <tr>
          <th>Nurse</th>
          <th>Note</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody>
        {% for n in notes %}
        <tr>
          <td>{{ n.nurse.user.name }}</td>
          <td>{{ n.note }}</td>
          <td>{{ n.created_at.strftime("%d %b %Y %H:%M") }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="text-muted">No notes available.</p>
    {% endif %}
  </div>
</div>

<!-- ================= VITALS ================= -->
<div class="card shadow-sm mb-4">
  <div class="card-header bg-light">
    <b>‚ù§Ô∏è Patient Vitals</b>
  </div>
  <div class="card-body">
    {% if vitals %}
    <table class="table table-sm table-bordered text-center">
      <thead class="table-light">
        <tr>
          <th>Recorded At</th>
          <th>BP</th>
          <th>Pulse</th>
          <th>SpO2</th>
          <th>Temp</th>
          <th>Sugar</th>
        </tr>
      </thead>
      <tbody>
        {% for v in vitals %}
        <tr>
          <td>{{ v.recorded_at.strftime("%d %b %Y %H:%M") }}</td>
          <td>{{ v.bp }}</td>
          <td>{{ v.pulse }}</td>
          <td>{{ v.spo2 }}</td>
          <td>{{ v.temperature }}</td>
          <td>{{ v.sugar if v.sugar else "-" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="text-muted">No vitals recorded.</p>
    {% endif %}
  </div>
</div>

<!-- ================= MEDICATIONS ================= -->
<div class="card shadow-sm mb-4">
  <div class="card-header bg-light">
    <b>üíä Prescribed Medications</b>
  </div>
  <div class="card-body">
    {% if medications %}
    <table class="table table-sm table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Medicine</th>
          <th>Dosage</th>
          <th>Timing</th>
          <th>Duration</th>
          <th>Price</th>
        </tr>
      </thead>
      <tbody>
        {% for m in medications %}
        <tr>
          <td>{{ m.medicine_name }}</td>
          <td>{{ m.dosage }}</td>
          <td>{{ m.timing | join(", ") }}</td>
          <td>{{ m.duration_days }}</td>
          <td>{% if m.price %}‚Çπ {{ m.price }}{% else %}-{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="text-muted">No medications prescribed.</p>
    {% endif %}
  </div>
</div>

</div>

<!-- ========================================================= -->
<!-- ================= BILLING TAB =========================== -->
<!-- ========================================================= -->
<div class="tab-pane fade" id="tab-billing">

<!-- ================= GENERATE BILL ================= -->
<div class="card shadow-sm mb-4">
  <div class="card-header bg-light">
    <b>üßæ Generate Bill</b>
  </div>
  <div class="card-body">

    <!-- DISCOUNT / EXTRA -->
    <div class="row g-2 mb-3">
      <div class="col-md-3">
        <input id="discount" type="number" class="form-control" placeholder="Discount">
      </div>
      <div class="col-md-3">
        <input id="extra_charges" type="number" class="form-control" placeholder="Extra Charges">
      </div>
    </div>

    <!-- OTHER ITEMS -->
    <h6 class="mt-3">Other Billing Items</h6>

    <table class="table table-sm table-bordered mb-3">
      <thead class="table-light">
        <tr>
          <th>Title</th>
          <th width="120">Qty</th>
          <th width="150">Unit Price</th>
          <th width="60"></th>
        </tr>
      </thead>
      <tbody id="otherItemsTable">
        <!-- rows added by JS -->
      </tbody>
    </table>

    <button class="btn btn-sm btn-outline-secondary mb-3" onclick="addOtherItemRow()">
      ‚ûï Add Item
    </button>

    <br>

    <button class="btn btn-sm btn-primary" onclick="generateBill()">
      Generate Bill
    </button>
  </div>
</div>

<!-- ================= BILL LIST ================= -->
<div class="card shadow-sm">
  <div class="card-header bg-light">
    <b>üìÑ Bills</b>
  </div>
  <div class="card-body">
      <!-- üëá ADD HERE -->
    <div class="d-flex justify-content-end mb-2">
      <input
        id="gst_download_percent"
        type="number"
        class="form-control form-control-sm"
        value="18"
        style="width:120px"
      />
    </div>
    <table class="table table-sm table-bordered">
      <thead class="table-light">
        <tr>
          <th>Date</th>
          <th>Amount</th>
          <th>Status</th>
          <th>PDF</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="billTable">
        <tr>
          <td colspan="5" class="text-center text-muted">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

</div>




</div>
</div>

<!-- <script>
document.getElementById("gst_enabled").addEventListener("change", function () {
  document.getElementById("gst_percent").disabled = !this.checked;
});
</script> -->

<script>
const patientId = "{{ patient.id }}";

/* ---------- OTHER ITEMS UI ---------- */
function addOtherItemRow() {
  const tbody = document.getElementById("otherItemsTable");
  const row = document.createElement("tr");

  row.innerHTML = `
    <td><input class="form-control item-title" placeholder="Service name"></td>
    <td><input type="number" class="form-control item-qty" value="1"></td>
    <td><input type="number" class="form-control item-price" placeholder="Amount"></td>
    <td>
      <button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">‚úñ</button>
    </td>
  `;
  tbody.appendChild(row);
}

/* ---------- GENERATE BILL ---------- */

function generateBill() {
  const otherItems = [];

  document.querySelectorAll("#otherItemsTable tr").forEach(row => {
    const title = row.querySelector(".item-title").value.trim();
    const qty = Number(row.querySelector(".item-qty").value);
    const price = Number(row.querySelector(".item-price").value);

    if (title && qty > 0 && price > 0) {
      otherItems.push({
        title,
        quantity: qty,
        unit_price: price
      });
    }
  });

  const payload = {
    patient_id: patientId,
    discount: Number(document.getElementById("discount").value) || 0,
    extra_charges: Number(document.getElementById("extra_charges").value) || 0,
    other_items: otherItems
  };

  fetch("/billing/admin/billing/generate", {
    method: "POST",
    headers: headers(),
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(d => {
    alert(d.message);
    loadBills();
  });
}

/* ---------- LOAD BILLS ---------- */
// function loadBills() {
//   fetch(`/billing/admin/patient/${patientId}/bills`, {
//     headers: headers()
//   })
//   .then(r => r.json())
//   .then(data => {
//     const tbody = document.getElementById("billTable");
//     tbody.innerHTML = "";

//     if (!data.length) {
//       tbody.innerHTML =
//         `<tr><td colspan="5" class="text-center">No bills</td></tr>`;
//       return;
//     }

//     data.forEach(b => {
//      tbody.innerHTML += `
// <tr>
//   <td>${new Date(b.date).toLocaleDateString()}</td>
//   <td>‚Çπ ${b.amount}</td>
//   <td>${b.status}</td>

//   <td>
//     <a href="/billing/admin/billing/${b.bill_id}/download"
//        target="_blank"
//        class="btn btn-sm btn-outline-secondary">
//        Non-GST
//     </a>

//     <a href="/billing/admin/billing/${b.bill_id}/download?gst_percent=18"
//        target="_blank"
//        class="btn btn-sm btn-outline-success ms-1">
//        GST
//     </a>
//   </td>

//   <td>
//     ${
//       b.status === "UNPAID"
//       ? `<button class="btn btn-sm btn-success"
//            onclick="markPaid('${b.bill_id}')">Mark Paid</button>`
//       : "-"
//     }
//   </td>
// </tr>
// `;
//     });
//   });
// }

function loadBills() {
  fetch(`/billing/admin/patient/${patientId}/bills`, {
    headers: headers()
  })
  .then(r => r.json())
  .then(data => {
    const tbody = document.getElementById("billTable");
    tbody.innerHTML = "";

    if (!data.length) {
      tbody.innerHTML =
        `<tr><td colspan="5" class="text-center">No bills</td></tr>`;
      return;
    }

    const gstPercent =
      document.getElementById("gst_download_percent")?.value || 18;

    data.forEach(b => {
      tbody.innerHTML += `
<tr>
  <td>${new Date(b.date).toLocaleDateString()}</td>
  <td>‚Çπ ${b.amount}</td>
  <td>${b.status}</td>

  <td>
    <a href="/billing/admin/billing/${b.bill_id}/download"
       target="_blank"
       class="btn btn-sm btn-outline-secondary">
       Non-GST
    </a>

    <a href="/billing/admin/billing/${b.bill_id}/download?gst_percent=${gstPercent}"
       target="_blank"
       class="btn btn-sm btn-outline-success ms-1">
       GST
    </a>
  </td>

  <td>
    ${
      b.status === "UNPAID"
      ? `<button class="btn btn-sm btn-success"
           onclick="markPaid('${b.bill_id}')">Mark Paid</button>`
      : "-"
    }
  </td>
</tr>
`;
    });
  });
}

/* ---------- MARK PAID ---------- */
function markPaid(id) {
  fetch(`/billing/admin/billing/mark-paid?bill_id=${id}`, {
    method: "POST",
    headers: headers()
  })
  .then(r => r.json())
  .then(d => {
    alert(d.message);
    loadBills();
  });
}

/* Load bills when Billing tab opens */
document
  .querySelector('a[href="#tab-billing"]')
  .addEventListener("click", loadBills);

// Re-load bills when GST % changes
document
  .getElementById("gst_download_percent")
  ?.addEventListener("input", loadBills);
</script>


{% endblock %}
