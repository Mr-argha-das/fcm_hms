{% extends "admin/base.html" %}
{% block title %}SOS Alert Full Details{% endblock %}

{% block content %}
<script>guard();</script>

<div class="card sos mb-4">
  <h4>ğŸš¨ SOS ALERT â€“ COMPLETE DETAILS</h4>
  <hr />

  <!-- SOS BASIC -->
  <h5>ğŸ”´ SOS Information</h5>
  <p><b>Status:</b>
    <span class="badge {% if sos.status == 'ACTIVE' %}bg-danger{% else %}bg-success{% endif %}">
      {{ sos.status }}
    </span>
  </p>
  <p><b>Message:</b> {{ sos.message }}</p>
  <p><b>Triggered At:</b> {{ sos.created_at.strftime("%d %b %Y %H:%M") }}</p>


  <hr />

  <!-- TRIGGERED USER -->
  <h5>ğŸ‘¤ Triggered By (User)</h5>
  <p><b>Name:</b> {{ sos.triggered_by.name }}</p>
  <p><b>Role:</b> {{ sos.triggered_by.role }}</p>
  <p><b>Phone:</b> {{ sos.triggered_by.phone }}</p>
  <p><b>Email:</b> {{ sos.triggered_by.email }}</p>

  <hr />

  <!-- PATIENT -->
  <h5>ğŸ§‘â€ğŸ¦½ Patient Details</h5>
  <p><b>Name:</b> {{ patient.user.name }}</p>
  <p><b>Age:</b> {{ patient.age }}</p>
  <p><b>Gender:</b> {{ patient.gender }}</p>
  <p><b>Phone:</b> {{ patient.user.phone }}</p>
  <p><b>Medical History:</b> {{ patient.medical_history }}</p>
  <p><b>Address:</b> {{ patient.address }}</p>
  <p><b>Service Period:</b>
    {{ patient.service_start }} â†’ {{ patient.service_end }}
  </p>

  <hr />

  <!-- DOCTOR -->
  {% if doctor %}
  <h5>ğŸ‘¨â€âš•ï¸ Assigned Doctor</h5>
  <p><b>Name:</b> {{ doctor.user.name }}</p>
  <p><b>Specialization:</b> {{ doctor.specialization }}</p>
  <p><b>Registration No:</b> {{ doctor.registration_number }}</p>
  <p><b>Experience:</b> {{ doctor.experience_years }} years</p>
  <p><b>Available:</b> {{ doctor.available }}</p>
  {% else %}
  <p class="text-muted">No doctor assigned</p>
  {% endif %}

  <hr />

  <!-- NURSE -->
  {% if nurse %}
  <h5>ğŸ‘©â€âš•ï¸ On-Duty Nurse</h5>
  <p><b>Name:</b> {{ nurse_user.name }}</p>
  <p><b>Phone:</b> {{ nurse_user.phone }}</p>
  <p><b>Nurse Type:</b> {{ nurse.nurse_type }}</p>
  <p><b>Aadhaar:</b> {{ nurse.aadhaar_number }}</p>
  <p><b>Verification:</b> {{ nurse.verification_status }}</p>
  <p><b>Police Verification:</b> {{ nurse.police_verification_status }}</p>
  {% else %}
  <p class="text-muted">No nurse currently assigned</p>
  {% endif %}

  <hr />

  <!-- DUTY -->
  {% if duty %}
  <h5>â° Active Duty</h5>
  <p><b>Duty Type:</b> {{ duty.duty_type }}</p>
  <p><b>Shift:</b> {{ duty.shift }}</p>
  <p><b>Duty Start:</b> {{ duty.duty_start }}</p>
  <p><b>Duty End:</b> {{ duty.duty_end }}</p>
  {% endif %}

  {% if sos.status == "ACTIVE" %}
  <button class="btn btn-danger mt-3" onclick="resolveSOS('{{ sos.id }}')">
    âœ… Mark as Resolved
  </button>
  {% endif %}
</div>

<script>
function resolveSOS(sosId) {
  if (!confirm("Resolve this SOS?")) return;

  fetch(`${API}/sos/admin/resolve-admin?sos_id=` + sosId, {
    method: "POST",
    headers: headers()
  })
  .then(r => r.json())
  .then(d => {
    alert(d.message);
    location.reload();
  })
}
</script>

{% endblock %}
