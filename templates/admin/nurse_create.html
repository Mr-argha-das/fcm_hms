{% extends "admin/base.html" %}
{% block title %}Create Nurse{% endblock %}

{% block content %}

<div class="card mb-4">
  <h4>Create Nurse</h4>
  <p class="text-muted">Step-by-step nurse onboarding</p>
</div>

<div class="mb-3">
  <span id="stepLabel" class="badge bg-primary"></span>
</div>

<form id="nurseForm">

  <!-- HIDDEN FIELDS -->
  <input type="hidden" id="qualification_docs">
  <input type="hidden" id="experience_docs">
  <input type="hidden" id="profile_photo">

  <!-- ================= STEP 1 ================= -->
  <div class="card step mb-4" id="step1">
    <h5>Basic Details</h5>
    <div class="row">
      <div class="col-md-6 mb-3">
        <label>Phone *</label>
        <input class="form-control" id="phone" required>
      </div>
      <div class="col-md-6 mb-3">
        <label>Email</label>
        <input class="form-control" id="email">
      </div>
      <div class="col-md-6 mb-3">
        <label>Nurse Type *</label>
        <select class="form-control" id="nurse_type" required>
          <option value="">Select</option>
          <option>GNM</option>
          <option>ANM</option>
          <option>CARETAKER</option>
          <option>PHYSIO</option>
          <option>COMBO</option>
        </select>
      </div>
      <div class="col-md-6 mb-3">
        <label>Aadhaar Number</label>
        <input class="form-control" id="aadhaar">
      </div>
    </div>
  </div>

  <!-- ================= STEP 2 ================= -->
  <div class="card step mb-4 d-none" id="step2">
    <h5>Documents & Photo</h5>

    <div class="mb-3">
      <label>Qualification Documents</label>
      <input type="file" class="form-control" multiple
             onchange="uploadMultipleFiles(this,'qualification_docs','documents')">
      <ul class="mt-2" id="qualification_docs_preview"></ul>
    </div>

    <div class="mb-3">
      <label>Experience Documents</label>
      <input type="file" class="form-control" multiple
             onchange="uploadMultipleFiles(this,'experience_docs','documents')">
      <ul class="mt-2" id="experience_docs_preview"></ul>
    </div>

    <div class="mb-3">
      <label>Profile Photo</label>
      <input type="file" accept="image/*" class="form-control"
             onchange="uploadSingleImage(this,'profile_photo','images')">
      <img id="profile_photo_preview"
           style="max-width:120px;border-radius:12px;margin-top:10px;display:none">
    </div>

    <div class="row">
      <div class="col-md-6 mb-3">
        <label>Joining Date</label>
        <input type="date" class="form-control" id="joining_date">
      </div>
      <div class="col-md-6 mb-3">
        <label>Resignation Date</label>
        <input type="date" class="form-control" id="resignation_date">
      </div>
    </div>
  </div>

  <!-- ================= STEP 3 ================= -->
  <div class="card step mb-4 d-none" id="step3">
    <h5>Shift & Salary</h5>
    <div class="row">
      <div class="col-md-4 mb-3">
        <label>Shift Type *</label>
        <select class="form-control" id="shift_type">
          <option>DAY</option>
          <option>NIGHT</option>
          <option>24_HOURS</option>
        </select>
      </div>
      <div class="col-md-4 mb-3">
        <label>Duty Hours *</label>
        <input type="number" class="form-control" id="duty_hours">
      </div>
      <div class="col-md-4 mb-3">
        <label>Salary Type *</label>
        <select class="form-control" id="salary_type">
          <option>MONTHLY</option>
          <option>DAILY</option>
        </select>
      </div>
      <div class="col-md-6 mb-3">
        <label>Salary Amount *</label>
        <input type="number" class="form-control" id="salary_amount">
      </div>
      <div class="col-md-6 mb-3">
        <label>Payment Mode *</label>
        <select class="form-control" id="payment_mode">
          <option>BANK</option>
          <option>CASH</option>
          <option>UPI</option>
        </select>
      </div>
      <div class="col-md-4 mb-3">
        <label>Salary Date *</label>
        <input type="number" min="1" max="31" class="form-control" id="salary_date">
      </div>
    </div>
  </div>

  <!-- BUTTONS -->
  <div class="d-flex justify-content-between">
    <button type="button" id="backBtn" class="btn btn-secondary d-none" onclick="prevStep()">Back</button>
    <button type="button" id="nextBtn" class="btn btn-primary" onclick="nextStep()">Next</button>
    <button type="submit" id="submitBtn" class="btn btn-success d-none">Create Nurse</button>
  </div>

</form>

<script>
const FILE_API = "/upload/file";
let step = 1;
const totalSteps = 3;

/* STEP CONTROL */
function showStep(){
  for(let i=1;i<=totalSteps;i++){
    document.getElementById("step"+i).classList.add("d-none");
  }
  document.getElementById("step"+step).classList.remove("d-none");

  stepLabel.innerText = `Step ${step} of ${totalSteps}`;

  backBtn.classList.toggle("d-none", step===1);
  nextBtn.classList.toggle("d-none", step===totalSteps);
  submitBtn.classList.toggle("d-none", step!==totalSteps);
}
function nextStep(){ if(step<totalSteps){ step++; showStep(); } }
function prevStep(){ if(step>1){ step--; showStep(); } }
showStep();

/* MULTIPLE FILE UPLOAD */
async function uploadMultipleFiles(input, fieldId, folder){
  const files = Array.from(input.files);
  let paths = document.getElementById(fieldId).value ? JSON.parse(document.getElementById(fieldId).value) : [];

  for(const file of files){
    const fd = new FormData();
    fd.append("file", file);
    fd.append("folder", folder);

    const res = await fetch(FILE_API,{method:"POST",body:fd});
    const data = await res.json();
    if(res.ok){
      paths.push(data.path);
      const li = document.createElement("li");
      li.innerText = "ðŸ“„ " + file.name;
      document.getElementById(fieldId+"_preview").appendChild(li);
    }
  }
  document.getElementById(fieldId).value = JSON.stringify(paths);
  input.value="";
}

/* SINGLE IMAGE UPLOAD */
async function uploadSingleImage(input, fieldId, folder){
  const fd = new FormData();
  fd.append("file", input.files[0]);
  fd.append("folder", folder);

  const res = await fetch(FILE_API,{method:"POST",body:fd});
  const data = await res.json();
  if(res.ok){
    document.getElementById(fieldId).value = data.path;
    profile_photo_preview.src = "/" + data.path;
    profile_photo_preview.style.display="block";
  }
}

/* SUBMIT */
nurseForm.onsubmit = async e =>{
  e.preventDefault();

  const payload = {
    phone: phone.value,
    email: email.value || null,
    nurse_type: nurse_type.value,
    aadhaar_number: aadhaar.value || null,
    qualification_docs: qualification_docs.value ? JSON.parse(qualification_docs.value) : [],
    experience_docs: experience_docs.value ? JSON.parse(experience_docs.value) : [],
    profile_photo: profile_photo.value || null,
    joining_date: joining_date.value || null,
    resignation_date: resignation_date.value || null,
    shift_type: shift_type.value,
    duty_hours: Number(duty_hours.value),
    salary_type: salary_type.value,
    salary_amount: Number(salary_amount.value),
    payment_mode: payment_mode.value,
    salary_date: Number(salary_date.value)
  };

  const res = await fetch("/nurse/create",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(payload)
  });

  if(res.ok) window.location.href="/admin/nurses";
  else alert("Error creating nurse");
};
</script>

{% endblock %}
